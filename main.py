import os
import logging
import httpx
import telebot
from telebot import types
from dotenv import load_dotenv

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ”§ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load_dotenv()

BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
YCLIENTS_PARTNER_TOKEN = os.getenv("YCLIENTS_PARTNER_TOKEN")
YCLIENTS_COMPANY_ID = os.getenv("YCLIENTS_COMPANY_ID")
YCLIENTS_LOGIN = os.getenv("YCLIENTS_LOGIN")
YCLIENTS_PASSWORD = os.getenv("YCLIENTS_PASSWORD")

bot = telebot.TeleBot(BOT_TOKEN)

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("kutikula_bot")

API_URL = "https://api.yclients.com/api/v1"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§© ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² YCLIENTS (Ñ‡ĞµÑ€ĞµĞ· Ğ»Ğ¾Ğ³Ğ¸Ğ½/Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def yclients_get_user_token():
    url = f"{API_URL}/auth"
    headers = {
        "Content-Type": "application/json",
        "Accept": "application/vnd.yclients.v2+json",
        "Authorization": f"Bearer {YCLIENTS_PARTNER_TOKEN}"
    }
    payload = {
        "login": YCLIENTS_LOGIN,
        "password": YCLIENTS_PASSWORD
    }

    async with httpx.AsyncClient(timeout=15) as client:
        response = await client.post(url, headers=headers, json=payload)
        data = response.json()
        if data.get("success") and data.get("data", {}).get("user_token"):
            return data["data"]["user_token"]
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ YCLIENTS: {data}")
        return None


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“‹ ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑƒÑĞ»ÑƒĞ³
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def yclients_get_services(user_token: str):
    url = f"{API_URL}/company/{YCLIENTS_COMPANY_ID}/services"
    headers = {
        "Accept": "application/vnd.yclients.v2+json",
        "Content-Type": "application/json",
        "Authorization": f"Bearer {YCLIENTS_PARTNER_TOKEN}, User {user_token}"
    }

    async with httpx.AsyncClient(timeout=15) as client:
        response = await client.get(url, headers=headers)
        data = response.json()
        if data.get("success"):
            return data["data"]
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑƒÑĞ»ÑƒĞ³: {data}")
        return None


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“… ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def yclients_get_records(user_token: str):
    url = f"{API_URL}/records/{YCLIENTS_COMPANY_ID}"
    headers = {
        "Accept": "application/vnd.yclients.v2+json",
        "Content-Type": "application/json",
        "Authorization": f"Bearer {YCLIENTS_PARTNER_TOKEN}, User {user_token}"
    }

    async with httpx.AsyncClient(timeout=15) as client:
        response = await client.get(url, headers=headers)
        data = response.json()
        if data.get("success"):
            return data["data"]
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹: {data}")
        return None


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async def yclients_cancel_record(user_token: str, record_id: int):
    url = f"{API_URL}/record/{YCLIENTS_COMPANY_ID}/{record_id}/delete"
    headers = {
        "Accept": "application/vnd.yclients.v2+json",
        "Content-Type": "application/json",
        "Authorization": f"Bearer {YCLIENTS_PARTNER_TOKEN}, User {user_token}"
    }

    async with httpx.AsyncClient(timeout=15) as client:
        response = await client.post(url, headers=headers)
        data = response.json()
        if data.get("success"):
            return True
        logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‹ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸: {data}")
        return False

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ¤– Telegram-Ğ±Ğ¾Ñ‚
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@bot.message_handler(commands=["start"])
def start(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("ğŸ“‹ Ğ£ÑĞ»ÑƒĞ³Ğ¸", "ğŸ—“ ĞœĞ¾Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸", "âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ")
    bot.send_message(message.chat.id, "ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ Ğ±Ğ¾Ñ‚ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ²Ğ¸Ğ·Ğ¸Ñ‚Ğ°Ğ¼Ğ¸ ğŸ’…", reply_markup=markup)


@bot.message_handler(func=lambda m: m.text == "ğŸ“‹ Ğ£ÑĞ»ÑƒĞ³Ğ¸")
def handle_services(message):
    import asyncio
    asyncio.run(send_services_list(message))


async def send_services_list(message):
    token = await yclients_get_user_token()
    if not token:
        bot.send_message(message.chat.id, "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ ğŸ˜”")
        return

    services = await yclients_get_services(token)
    if not services:
        bot.send_message(message.chat.id, "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑƒÑĞ»ÑƒĞ³.")
        return

    text = "ğŸ“‹ *Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑƒÑĞ»ÑƒĞ³:*\n\n"
    for s in services:
        text += f"â€¢ {s['title']} â€” {s.get('price_min', 'â€”')}â‚½\n"
    bot.send_message(message.chat.id, text, parse_mode="Markdown")


@bot.message_handler(func=lambda m: m.text == "ğŸ—“ ĞœĞ¾Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸")
def handle_records(message):
    import asyncio
    asyncio.run(send_user_records(message))


async def send_user_records(message):
    token = await yclients_get_user_token()
    if not token:
        bot.send_message(message.chat.id, "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ ğŸ˜”")
        return

    records = await yclients_get_records(token)
    if not records:
        bot.send_message(message.chat.id, "Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹.")
        return

    text = "ğŸ—“ *Ğ’Ğ°ÑˆĞ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸:*\n\n"
    for r in records:
        text += f"â€¢ {r['services'][0]['title']} â€” {r['date']} ({r['staff']['name']})\n"
    bot.send_message(message.chat.id, text, parse_mode="Markdown")


@bot.message_handler(func=lambda m: m.text == "âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ")
def handle_cancel(message):
    bot.send_message(message.chat.id, "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ID Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸, ĞºĞ¾Ñ‚Ğ¾Ñ€ÑƒÑ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ.")


@bot.message_handler(func=lambda m: m.text.isdigit())
def cancel_record_by_id(message):
    import asyncio
    record_id = int(message.text)
    asyncio.run(cancel_record_action(message, record_id))


async def cancel_record_action(message, record_id):
    token = await yclients_get_user_token()
    if not token:
        bot.send_message(message.chat.id, "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ ğŸ˜”")
        return

    success = await yclients_cancel_record(token, record_id)
    if success:
        bot.send_message(message.chat.id, f"âœ… Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ â„–{record_id} ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°.")
    else:
        bot.send_message(message.chat.id, "âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if name == "__main__":
    logger.info("Ğ—Ğ°Ğ¿ÑƒÑĞº Telegram-Ğ±Ğ¾Ñ‚Ğ°...")
    bot.infinity_polling()
